## 2.2 TCP/IP 标准化

### 2.2.1 TCP/IP 的具体含义

从字面意义上讲，有人可能会认为 TCP/IP 是指 TCP 和 IP 两种协议。实际生活当中有时也确实就是指这两种协议。然而在很多情况下，它只是利用 IP 进行通信时所必须用到的协议群的统称。具体来说，IP 或 ICMP、TCP 或 UDP、TELNET 或 FTP、以及 HTTP 等都属于 TCP/IP 的协议。他们与 TCP 或 IP 的关系紧密，是互联网必不可少的组成部分。 TCP/IP 一词泛指这些协议，因此，有时也称 TCP/IP 为国际协议族。



### 2.4.1 TCP/IP 与 OSI 参考模型

![tcpip1](../.vuepress/public/images/tcpip1.png)

### 2.4.2 硬件（物理层）

TCP/IP 的最底层是负责数据传输的硬件。这种硬件就相当于以太网或电话线路等物理层的设备。关于它的内筒一直无法统一定义。因为只要人们在物理层面上所使用的传输媒介不同（如使用网线或无线），网络的带宽、可靠性、安全性、延迟等都会有所不同，而在这些方面又没有一个既定的指标。总之，TCP/IP 是在网络互连的设备之间能够通信的前提下才被提出的协议。

### 2.4.3 网络接口层（数据链路层）

网络接口层利用以太网中的数据链路层进行通信，因此属于接口层。也就是说，把它当做让 NIC 起作用的“驱动程序”也无妨。驱动程序是在操作系统与硬件之间起桥梁作用的软件。计算机的外围附加设备或拓展卡，不是直接插到电脑或电脑的拓展槽上就能马上使用的，还需要有相应的驱动程序的支持。例如换了一个新的 NIC 网卡，不仅需要硬件，还需要软件才能真正投入使用。因此，人们常常还需要在操作系统的基础上安装一些驱动软件以便使用这些附加硬件。

### 2.4.4 互联网层（网络层）

TCP/IP 分层中的互联网层与传输层的功能通常由操作系统提供。尤其是路由器，它必须得实现通过互联网层转发分组数据包的功能。

#### IP

IP 是跨越网络传送数据包，使整个互联网都能收到数据的协议。

虽然 IP 也是数据交换的一种协议，但是它不具备重发机制，即使分组数据包未能到达对端主机也不会重发。因此，属于非可靠性传输协议。

#### ICMP

IP 数据包在发送途中一旦发生异常导致无法到达对端目标地址时，需要给发送端发送一个发生异常的通知。ICMP 就是为这一功能而制定的。它有时也被用来诊断网络的健康状况。

#### ARP

从分组数据包的 IP 地址中解析出物理地址（MAC地址）的一种协议。

### 2.4.5 传输层

传输层的最主要的功能就是能够让应用程序之间实现通信。计算机内部，通常同一时间运行着多个程序，为此，必须分清是哪些程序与哪些程序在进行通信。识别这些应用程序的是端口号。

#### TCP

TCP 是一种面向有连接的传输层协议。它可以保证两端的通信主机之间的通信可达。TCP能够正确处理在传输过程中丢包、传输顺序乱掉等异常情况。此外，TCP 还能够有效利用带宽，缓解网络拥堵。

然而，为了建立与断开连接，有时它需要至少 7 次的发包收包，导致网络流量的浪费。此外，为了提高网络的利用率，TCP 协议中定义了各种各样复杂的规范，因此不利于视频会议（音频、视频的数据量既定）等场合使用。

#### UDP

UDP 有别于 TCP，它是一种面向无连接的传输层协议。UDP 不会关注对端是否真的收到了传送过去的数据，如果需要检查对端是否收到分组数据包，或者对端是都连接到网络，则需要在应用程序中实现。

UDP 常用于分组数据较少或多播、广播通信以及视频通信等多媒体领域。

### 2.4.6 应用层（会话层以上的分层）

TCP/IP 分层中，将 OSI 参考模型中的会话层、表示层和应用层的功能都集中到了应用程序中实现。

TCP/IP 应用的架构绝大多数属于客户端/服务端模型。

#### WWW

#### E-Mail 

#### 文件传输（FTP）

在 FTP 中进行文件传输时会建立两个 TCP 连接，分别是发出传输请求时所要用到的控制连接与实际传输数据时所要用到的数据连接。

#### 远程登录（TELNET 与 SSH）

远程登录是登录到远程的计算机上，使那台计算机上的程序得以运行的一种功能。 TCP/IP 网络中远程登录常用 TELNET 和 SSH 两种协议。

#### 网络管理（SNMP）

在 TCP/IP 中进行网络管理时，采用 SNMP 协议。使用 SNMP 管理的主机、网桥、路由器等称作 SNMP 代理（Agent），而进行管理的那一段叫做管理器（Manager）。SNMP 正是这个 Manager 与 Agent 所要用到的协议。

### 4.2.4 IP 属于面向无连接型

IP 面向无连接。即在发包之前，不需要建立与对端目标地址之间的连接。上层如果遇到需要发送 IP 的数据，上层如果遇到需要发送给 IP 的数据，该数据会立即被压缩成 IP 包发送出去。

##### 为什么IP要采用面向无连接呢？

1. 简化：面向连接比起面向无连接处理相对复杂。甚至管理每个连接本身就是一个相当繁琐的事情。
2. 提速：每次通信之前都要事先先建立连接，又会降低处理速度。**需要有连接时，可以委托上一层提供此项服务（TCP）**。

### 4.3.1 IP 地址的定义

IP 地址（IPv4地址）由32位正整数来表示。TCP/IP 通信要求将这样的 IP 地址分配给每一个参与通信的主机。IP 地址在计算机内部以二进制方式被处理。然而，由于人类社会并不习惯于采用二进制方式，需要采用一种特殊的标记方式。那就是将32位的 IP 地址以每 8 位为一组，分成 4 组，每组以 "." 隔开，再将每组数转化为 10 进制。

将表示成 IP 地址的数字整体计算，会得出如下数值 2^32 = 4 294 967 296

从这个计算可知，最多可以允许 43 亿台计算机连接到网络。实际上，IP 地址并非是根据主机台数来配置的，而是每一台主机上的每一块网卡（NIC）都得设置 IP 地址。通常一块网卡只设置一个 IP 地址，其实一块网卡也可以配置多个 IP 地址。此外，一台了路由器通常都会配置两个以上的网卡，因此可以设置两个以上的 IP 地址。

后面将要详细介绍 IP 地址的两个组成部分（网络标识和主机标识），了解了这两个组成部分后你会发现实际能够连接到网络中的计算机个数更是少了很多。

### 4.3.2 IP 地址由网络和主机两部分标识组成

网络标识在书记链路的每个段配置不同的值。网络标识必须保证相互连接的每个段的地址不相重复。而相同段内相连的主机必须有相同的网络地址。 IP 地址的"主机标识"则不允许在同一个网段内重复出现。

由此 ，可以通过设置网络地址和主机地址，在相互连接的整个网路中保证每台主机的 IP 地址都不会相互重复。 即 IP 地址具有了唯一性。

![ip](../.vuepress/public/images/ip.png)



### 4.3.3 IP 地址的分类

#### A 类地址

A 类 IP 地址是首位以 0 开头的地址。从第 1 位 到第 8 位是它的网络标识。用十进制的话，0.0.0.0~127.0.0.0 是 A 类的网络地址。A 类地址的后面 24 位相当于主机标识。因此，一个网段内可容纳 的主机地址上限为 16 777 214 个。

#### B 类地址

B 类 IP地址是前两位为 10 的地址。从第 1 位到第 16 位是它的网络标识。用十进制表示的话，128.0.0.1~191.255.0.0 是 B 类的网络地址。 B 类地址的后16 位相当于主机标识。因此，一个网段内可容纳的主机地址上限为 65 534 个。

#### C 类地址

C 类 IP地址是前两位为 110 的地址。从第 1 位到第 24 位是它的网络标识。用十进制表示的话，192.168.0.0~239.255.255.0 是 C 类的网络地址。 C 类地址的后 8 位相当于主机标识。因此，一个网段内可容纳的主机地址上限为 254 个。

#### D 类地址

C 类 IP地址是前两位为 1110 的地址。从第 1 位到第 32 位是它的网络标识。用十进制表示的话，224.0.0.0~239.255.255.255 是 D 类的网络地址。 D 类地址没有主机标识。常用于多播。

![ip2](../.vuepress/public/images/ip2.png)

#### 关于分配 IP 主机地址的注意事项

在分配 IP 地址时关于主机标识有一点需要注意。即要用比特位表示主机地址时，不可以全部为 0 或全部为 1。

因为全部为 0 在表示对应的网络地址或 IP 地址不可获知的情况下才使用。而全部为 1 的主机地址通常作为广播地址。

### 4.3.6 子网掩码

子网掩码用二进制方式表示的话，也是一个 32 位的数字。它对应 IP 地址网络标识部分的位全部为 1， 对应 IP 地址主机标识的部分则全部为 0。由此，一个 IP 地址可以不再受限于自己的类别，而是可以用这样的子网掩码自由地定位自己的网络标识长度。

对于子网掩码，目前有两种标识方式。以 172.20.100.52 的前 26 位是网络地址的情况为例，以下是其中一种表示方式，它将 IP 地址与子网掩码的地址分别用两行来表示

![ip3](../.vuepress/public/images/ip3.png)

另外一种表示方式如下所示。它将每个 IP 地址后面追加网路地址的位数用 "/" 隔开

![ip4](../.vuepress/public/images/ip4.png)



### 4.3.7 CIDR 和 VLSM

采用任意长度分割 IP 地址的网络标识和主机标识，这种方式叫做 CIDR，意为“无类型域间选路”。根据 CIDR，连续多个C C 类地址就可以划分到一个较大的网络内。CIDR 更有效地利用了当前 IPv4 地址，同时通过路由集中降低了路由器的负担。

在 CIDR 被应用到互联网的处理，网络内部采用固定长度的子网掩码机制，也就是说，当子网掩码的长度被设置为 /25 之后，域内所有的子网掩码都得使用同样的长度。但部门不同可能有不同的主机数，如果全部采用统一标准，就难以架构一个高效的网络结构。为此人们提出了组织内要使用可变长度的、高效的 IP 地址分配方式。

于是产生一种可以随机修改组织内各个部门的子网掩码长度的机制——VLSM（可变长子网掩码）。

### 4.3.8 全局地址与私有地址

随着互联网技术的迅速普及，IP 地址不足的问题日趋显著。如果一直按照现行的方法采用唯一地址的话，会有 IP 地址耗尽的危险。于是就出现了一种新技术。它不要求为每一台主机或路由器分配一个固定的 IP 地址，而是在必要的时候只为相应数量的设备分配唯一的 IP 地址。

于是出现了私有网络的 IP地址。它的范围地址如下所示：

![ip5](../.vuepress/public/images/ip5.png)

包含在这个范围内的 IP 地址都属于私有 IP，而在此之外的 IP 地址称为全局 IP。

私有 IP 最早没有计划连接互联网，而只用于互联网之外的独立网络。然而，当一种能够互换私有 IP 与全局 IP 的 NAT 技术诞生以后，配有私有地址的主机与配有全局地址的互联网直击实现了通信。

全局 IP 地址基本上要在整个互联网范围内保持唯一，但私有地址不需要。只要在同一个域里保证唯一即可。在不同的域里出现相同的私有 IP 不会影响使用。

### 4.6.1 IPv6 的特点

- IP 地址的扩大与路由控制表的聚合
  - IP 地址依然适应互联网分层构造。分配与其地址结构相适应的 IP 地址，尽可能避免路由表膨大。
- 性能提升
  - 包首部长度采用固定的值（40字节），不再采用首部检验码。简化首部结构，减轻路由器负荷。路由器不再做分片处理。
- 支持即插即用功能
  - 即使没有 DHCP 服务器也可以实现自动分配 IP 地址。
- 采用认证与加密功能
  - 应对伪造 IP 地址的网络安全功能以及防止线路窃听的功能（IPsec）。
- 多播、Mobile IP 称为拓展功能
  - 多播和 Mobile IP 被定义为 IPv6 的拓展功能。由此可以预期，曾在 IPv4 中难于应用的这两个功能在 IPv6 中能够顺利使用。

### 4.6.3 IPv6 中 IP 地址的标记方法

IPv6 的 IP 地址长度为 128 位。它所能表示的数字高达 38 位数 （2^128 = 约为 3.40 * 10^38）。这可谓是天文数字。足以为人们所能想象到的所有主机和路由器分配地址。

### 6.2.4 端口号如何确定

#### 标准既定的端口号

这种方法也叫静态方法。它是指每个应用程序都有其指定的端口号。但并不是说可以随意使用任何一个端口号。每个端口号都有其对应的使用目的。

例如，HTTP、TELNET、FTP 等广为使用的应用协议中所使用的端口号就是固定的。这些端口号也被称之为知名端口号。下表列出了 TCP 和 UDP 具有代表性的知名端口号。知名端口号一般由 0 到 1023 的数字分配而成。应用程序应该避免使用知名端口号进行既定目的之外的通信，以免产生冲突。

除了知名端口号之外，还有一些端口号也被正式注册。它们分布在 1024 到 49151 的数字之间。不过，这些端口号可用于任何通信用途。

![tcp](../.vuepress/public/images/tcp.png)

![tcp2](../.vuepress/public/images/tcp2.png)

![udp1](../.vuepress/public/images/udp1.png)

![udp2](../.vuepress/public/images/udp2.png)

#### 时序分配法

第二种也叫时序（或动态的）分配法。此时，服务端有必要确定监听端口号，但是接受服务的客户端没必要确定端口号。

在这种方法下，客户端应用程序可以完全不用自己设置端口号，而全权交给操作系统分配。操作系统可以为每个应用分配互不冲突的端口号。根据这种动态分配端口号的机制，即使是同一个客户端程序发起的多个 TCP 连接，识别这些通信连接的 5 部分数字也不会全部相同。

动态分配的端口号取值范围在 49152~65535 之间。

### 6.2.5 端口号与协议

端口号由其使用的传输层协议决定。因此，不同的传输协议可以使用相同的端口号。例如，TCP 与 UDP 使用同一个端口号，但使用目的各不相同。这是因为端口号上的处理是根据每个传输协议的不同而进行的。

数据到达 IP 层后，会先检查 IP 首部中的协议号，再传给相应协议的模块。如果是 TCP 则传给 TCP 模块，如果是 UDP 则传给 UDP 模块去做端口号的处理。即使是 同一个端口号，由于传输协议使各自独立地进行处理，因此相互之间不会受到影响。

此外，那些知名端口号与传输层协议并无关系，只要端口一致都将分配同一种程序进行处理。例如，53 号端口在 TCP 与 UDP 中都用于 DNS 服务，而 80 端口用于 HTTP 通信。从目前来看，由于 HTTP 通信必须使用 TCP， 因此 UDP 的 80 端口并未投入使用。但是将来，如果 HTTP 协议的实现也开始对应 UDP 协议以及应用协议被相应扩展的情况下，就可以原样使用与 TCP 保持相同的 80 端口号了。

### 6.4.2 通过序列号与确认应答提高可靠性

TCP 的数据长度并未写入 TCP 首部。实际通信中求得 TCP 包的长度的计算公式是：IP 首部中的数据包长度 - IP 首部长度 TCP 首部长度。

### 6.4.3 重发超时如何确定

TCP 要求不论处在何种网络环境下都要提供高性能通信，并且无论网络拥堵情况发生何种变化，都必须保持这一特性。为此，它在每次发包时都会计算往返时间及其偏差。将这个往返时间和偏差相加重发超时的时间，就是比这个总和要稍大一点的值。

### 6.4.6 利用窗口控制提高速度

TCP 以 1 段为单位，每发放一个段进行一次确认应答的处理。这样的传输方式有一个缺点，那就是往返时间越长通信性能就越低。

为了解决这个问题，TCP 引入了窗口这个概念。即使在往返时间较长的情况下，它也能控制网络性能的下降。如下图所示，确认应答不再是以每个分段，而是以更大的单位进行确认时，转发时间将会被大幅度的缩短。也就是说，发送端主机，在发送了一个段以后不必要一直等待确认应答，而是继续发送。

窗口大小就是指无需等待确认应答而可以继续发送数据的最大值。下图中，窗口大小为 4 个段。

这个机制实现了大量的缓冲区，通过对多个段同时进行确认应答的功能。

在窗口内的数据及时没有收到确认应答也可以发送出去。此外，从该窗口中能看到的数据因其某种数据已在传输中丢失，所以发送端才能收到确认应答，这种情况下也许进行重发。为此，发送端主机在等到确认应答返回之前，必须在缓冲区中保留着部分数据。

在滑动窗口意外的部分包括尚未发送的数据以及已经确认对端已收到的数据。当数据发出后若如期收到确认应答就可以不用再进行重发。此时数据就可以从缓存区清除。

收到确认应答的情况下，将窗口滑动到确认应答中的序列号的位置。这样可以顺序地将多个段同时发送提高通信性能。这种机制也被称为滑动窗口控制。

![窗口1](../.vuepress/public/images/窗口1.png)

### 8.2.1 TELNET

TELNET 利用 TCP 的一条连接，通过这一条连接向主机发送文字命令并在主机上执行。本地用户好像直接与远端主机内部的 Shell 相连着似的，直接在本地进行操作。

TELNET 可以分为两类服务。一是仿真终端功能，二是协商选项机制。

#### TELNET 客户端

所谓 TELNET 客户端是指利用 TELNET 协议实现远程登录的客户端程序。很多情况下，它的程序名就是 telnet 命令。

TELNET 客户端通常与目标主机的 23 号端口建立连接，并与监听这个端口的服务端程序 telnetd 进行交互。当然，也可以与其他的 TCP 端口号连接，只要在该端口上有监听程序能够处理 telnet 请求即可。

### 8.2.2 SSH

SSH 是加密的远程登录系统。 TELNET 中登录无需输入密码就可以发送，容易造成通信窃听和非法入侵的危险。使用 SSH 后可以加密通信内容。即使信息被窃听也无法破解所发送的密码、具体命令以及命令返回的结果是什么。

### 9.4.1 IPsec 与 VPN

为了防止信息泄露，对机密数据的传输一般不使用互联网等公共网络（Public Network），而是使用由专线连接的私有网络（Private Network）。从而在物理上杜绝了窃听和篡改数据的可能。然而，专线的造价太高是一个不可回避的问题。

为了解决此类问题，人们想出了在互联网上构造一个虚拟的私有网络。VPN（Virtual Private Network，虚拟专用网）。互联网中采用加密和认证技术可以达到“即使读取到数据也无法读懂”、“检查是否被篡改”等功效。VPN 正是一种利用这两种技术打造的网络。

在构建 VPN 时，最常被使用的是 IPsec。它是指在 IP 首部的后面追加“封装安全有效载荷”和“认证首部”，从此对此后的数据进行加密，不被盗取者轻易解读。

在发包的时候附加上述两个首部，可以在收包时根据首部对数据进行解密，恢复成原始数据。由此，加密后的数据不再被轻易破解，即使在途中被篡改，也能够被及时检测。

### 9.4.2 TLS/SSL 与 HTTPS

Web 中可以通过 TLS/SSL 对 HTTP 通信进行加密。使用 TLS/SSL 的 HTTP 通信叫做 HTTPS 通信。HTTPS 中采用对称加密方式。而在发送其公共密钥时采用的则是公钥加密方式（非对称加密）。

![https1](../.vuepress/public/images/https1.png)

确认公钥是否正确主要使用认证中心 CA 签发的证书，而主要的认证中心的信息已经嵌入到浏览器的出厂设置中。如果 Web 浏览器中尚未加入某个认证中心，那么会在页面上提示一个警告信息。此时，判断认证中心合法与否就要由用户自己决定了。
